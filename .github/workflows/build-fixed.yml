name: ä¿®å¤ç‰ˆæ„å»º (Fixed Build)

on:
  push:
    branches: [ main, master, Cookie, fix ]
    tags: [ 'v*', 'fix-*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      use_fixed_build:
        description: 'ä½¿ç”¨ä¿®å¤ç‰ˆæ„å»ºè„šæœ¬'
        required: true
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  BUILD_VERSION: ${{ github.ref_name || 'dev' }}

jobs:
  build-fixed-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: è®¾ç½®UTF-8ç¼–ç ç¯å¢ƒ
      run: echo PYTHONIOENCODING=utf-8 >> $env:GITHUB_ENV
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        # å®‰è£…Windowsæ„å»ºå·¥å…·
        python -m pip install --upgrade pip
        python -m pip install wheel setuptools
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller
        
    - name: éªŒè¯ä¾èµ–å®‰è£…
      run: |
        python -c "import flet; print('Fletç‰ˆæœ¬:', flet.__version__)"
        python -c "import requests; print('Requestsç‰ˆæœ¬:', requests.__version__)"
        python -c "import plyer; print('Plyerå·²å®‰è£…')"
        python -c "import urllib3; print('urllib3ç‰ˆæœ¬:', urllib3.__version__)"
        python -c "import certifi; print('certifiå·²å®‰è£…')"
        python -c "import charset_normalizer; print('charset_normalizerå·²å®‰è£…')"
        python -c "import idna; print('idnaç‰ˆæœ¬:', idna.__version__)"
        pyinstaller --version
        
    - name: æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
      run: |
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
        
    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (ä¿®å¤ç‰ˆ)
      shell: pwsh
      run: |
        Write-Output "ğŸ”§ ä½¿ç”¨ä¿®å¤ç‰ˆæ„å»ºè„šæœ¬..."
        Write-Output "ä¿®å¤å†…å®¹:"
        Write-Output "  - æ·»åŠ äº†å®Œæ•´çš„ä¾èµ–åŒ…æ”¶é›†"
        Write-Output "  - ä¼˜åŒ–äº†éšè—å¯¼å…¥é…ç½®"
        Write-Output "  - ç¦ç”¨äº†UPXå‹ç¼©é¿å…å…¼å®¹æ€§é—®é¢˜"
        Write-Output "  - è§£å†³äº†æ— é™å¾ªç¯åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜"
        Write-Output ""
        python build_fixed.py
        
    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        if (Test-Path "dist\PD-Signal.exe") {
          Write-Output "âœ… ä¿®å¤ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          $fileSize = (Get-Item "dist\PD-Signal.exe").Length / 1MB
          Write-Output "æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ
          $fileInfo = Get-Item "dist\PD-Signal.exe"
          Write-Output "æ–‡ä»¶ç‰ˆæœ¬: $($fileInfo.VersionInfo.FileVersion)"
          Write-Output "åˆ›å»ºæ—¶é—´: $($fileInfo.CreationTime)"
          Write-Output "ä¿®æ”¹æ—¶é—´: $($fileInfo.LastWriteTime)"
        } else {
          Write-Output "âŒ ä¿®å¤ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: åˆ›å»ºä¿®å¤ç‰ˆå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        $releaseDir = "release\PD-Signal-Fixed"
        if (Test-Path $releaseDir) { Remove-Item -Recurse -Force $releaseDir }
        New-Item -ItemType Directory $releaseDir
        
        # å¤åˆ¶ä¸»è¦æ–‡ä»¶
        Copy-Item "dist\PD-Signal.exe" "$releaseDir\"
        Copy-Item "dist\å¯åŠ¨PD-Signal.bat" "$releaseDir\"
        Copy-Item "dist\ä½¿ç”¨è¯´æ˜.txt" "$releaseDir\"
        
        # å¤åˆ¶æºç å’Œæ–‡æ¡£
        New-Item -ItemType Directory "$releaseDir\source"
        Copy-Item "*.py" "$releaseDir\source\"
        Copy-Item "requirements.txt" "$releaseDir\source\"
        Copy-Item "README_CN.md" "$releaseDir\source\"
        Copy-Item "project_overview.md" "$releaseDir\source\"
        
        # åˆ›å»ºä¿®å¤è¯´æ˜
        $fixInfo = "PD Signal - PandaLiveç›‘æ§å·¥å…· (ä¿®å¤ç‰ˆ)`nç‰ˆæœ¬: ${{ env.BUILD_VERSION }}`næ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`næ„å»ºç¯å¢ƒ: GitHub Actions Windows (ä¿®å¤ç‰ˆ)`nPythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}`nGitæäº¤: ${{ github.sha }}`n`nğŸ”§ ä¿®å¤å†…å®¹:`n- è§£å†³äº†æ— é™å¾ªç¯åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜`n- æ·»åŠ äº†å®Œæ•´çš„ä¾èµ–åŒ…æ”¶é›†`n- ä¼˜åŒ–äº†éšè—å¯¼å…¥é…ç½®`n- ç¦ç”¨äº†UPXå‹ç¼©é¿å…å…¼å®¹æ€§é—®é¢˜`n- ç²¾ç®€äº†æ„å»ºå‚æ•°é¿å…å‘½ä»¤è¿‡é•¿`n`nâœ… ä¿®å¤æ•ˆæœ:`n- ç¨‹åºå¯ä»¥æ­£å¸¸å¯åŠ¨å’Œè¿è¡Œ`n- ä¸å†å‡ºç°æ— é™å¾ªç¯åˆ›å»ºè¿›ç¨‹`n- åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¾èµ–åŒ…`n- æ„å»ºè¿‡ç¨‹æ›´åŠ ç¨³å®šå¯é "
        $fixInfo | Out-File -FilePath "$releaseDir\ä¿®å¤è¯´æ˜.txt" -Encoding UTF8
        
        # åˆ›å»ºå®‰è£…è¯´æ˜
        $installGuide = "# PD Signal ä¿®å¤ç‰ˆå®‰è£…è¯´æ˜`n`n## ğŸ‰ ä¿®å¤å†…å®¹`n- âœ… è§£å†³äº†æ— é™å¾ªç¯åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜`n- âœ… æ·»åŠ äº†å®Œæ•´çš„ä¾èµ–åŒ…æ”¶é›†`n- âœ… ä¼˜åŒ–äº†éšè—å¯¼å…¥é…ç½®`n- âœ… ç¦ç”¨äº†UPXå‹ç¼©é¿å…å…¼å®¹æ€§é—®é¢˜`n`n## ç³»ç»Ÿè¦æ±‚`n- Windows 10/11 (64ä½)`n- æ— éœ€å®‰è£…Pythonæˆ–å…¶ä»–ä¾èµ–`n`n## å®‰è£…æ­¥éª¤`n1. ä¸‹è½½ PD-Signal.exe`n2. åŒå‡»è¿è¡Œå³å¯`n3. é¦–æ¬¡ä½¿ç”¨è¯·è®¾ç½®PandaLive Cookie`n`n## ä½¿ç”¨è¯´æ˜`n- è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹`"ä½¿ç”¨è¯´æ˜.txt`"`n- ä¿®å¤è¯¦æƒ…è¯·æŸ¥çœ‹`"ä¿®å¤è¯´æ˜.txt`"`n`n## æŠ€æœ¯æ”¯æŒ`n- GitHub: ${{ github.repository }}`n- æäº¤: ${{ github.sha }}`n- ä¿®å¤ç‰ˆæœ¬: ${{ env.BUILD_VERSION }}"
        $installGuide | Out-File -FilePath "$releaseDir\å®‰è£…è¯´æ˜.md" -Encoding UTF8
        
    - name: ä¸Šä¼ ä¿®å¤ç‰ˆæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Fixed-${{ github.run_number }}
        path: |
          dist/
          release/PD-Signal-Fixed/
        retention-days: 30
        
    - name: åˆ›å»ºå‘å¸ƒ (ä»…æ ‡ç­¾æ¨é€æ—¶)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/PD-Signal.exe
          dist/å¯åŠ¨PD-Signal.bat
          dist/ä½¿ç”¨è¯´æ˜.txt
          release/PD-Signal-Fixed/ä¿®å¤è¯´æ˜.txt
          release/PD-Signal-Fixed/å®‰è£…è¯´æ˜.md
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## PD Signal ä¿®å¤ç‰ˆ v${{ github.ref_name }}
          
          ### ğŸ”§ ä¿®å¤å†…å®¹
          - âœ… **è§£å†³äº†æ— é™å¾ªç¯åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜**
          - âœ… æ·»åŠ äº†å®Œæ•´çš„ä¾èµ–åŒ…æ”¶é›†
          - âœ… ä¼˜åŒ–äº†éšè—å¯¼å…¥é…ç½®
          - âœ… ç¦ç”¨äº†UPXå‹ç¼©é¿å…å…¼å®¹æ€§é—®é¢˜
          - âœ… ç²¾ç®€äº†æ„å»ºå‚æ•°é¿å…å‘½ä»¤è¿‡é•¿
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `PD-Signal.exe` ç›´æ¥è¿è¡Œ
          - ä½¿ç”¨ `å¯åŠ¨PD-Signal.bat` å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡º
          - è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ `ä½¿ç”¨è¯´æ˜.txt`
          - ä¿®å¤è¯¦æƒ…è¯·æŸ¥çœ‹ `ä¿®å¤è¯´æ˜.txt`
          
          ### ğŸ¯ ä¿®å¤æ•ˆæœ
          - ç¨‹åºå¯ä»¥æ­£å¸¸å¯åŠ¨å’Œè¿è¡Œ
          - ä¸å†å‡ºç°æ— é™å¾ªç¯åˆ›å»ºè¿›ç¨‹
          - åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¾èµ–åŒ…
          - æ„å»ºè¿‡ç¨‹æ›´åŠ ç¨³å®šå¯é 
          
          ### ğŸ“‹ åŠŸèƒ½ç‰¹ç‚¹
          - âœ… å¤šä¸»æ’­ç›‘æ§
          - âœ… å®æ—¶é€šçŸ¥
          - âœ… ç°ä»£åŒ–GUIç•Œé¢
          - âœ… æ•°æ®æŒä¹…åŒ–å­˜å‚¨
          - âœ… é…ç½®è‡ªåŠ¨ä¿å­˜
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¾“å‡ºæ„å»ºä¿¡æ¯
      shell: pwsh
      run: |
        Write-Output "=========================================="
        Write-Output "ğŸ‰ ä¿®å¤ç‰ˆæ„å»ºå®Œæˆï¼"
        Write-Output "=========================================="
        Write-Output "ğŸ“ æ„å»ºäº§ç‰©:"
        Get-ChildItem "dist" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Output "   - $($_.Name) ($([math]::Round($size, 2)) MB)"
        }
        Write-Output ""
        Write-Output "ğŸ“¦ ä¿®å¤ç‰ˆå‘å¸ƒåŒ…:"
        Get-ChildItem "release\PD-Signal-Fixed" | ForEach-Object {
          Write-Output "   - $($_.Name)"
        }
        Write-Output ""
        Write-Output "ğŸ”§ ä¿®å¤å†…å®¹:"
        Write-Output "   - è§£å†³äº†æ— é™å¾ªç¯åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜"
        Write-Output "   - æ·»åŠ äº†å®Œæ•´çš„ä¾èµ–åŒ…æ”¶é›†"
        Write-Output "   - ä¼˜åŒ–äº†éšè—å¯¼å…¥é…ç½®"
        Write-Output "   - ç¦ç”¨äº†UPXå‹ç¼©é¿å…å…¼å®¹æ€§é—®é¢˜"
        Write-Output ""
        Write-Output "ğŸ’¡ ä½¿ç”¨è¯´æ˜:"
        Write-Output "   1. ä¸‹è½½ PD-Signal.exe è¿è¡Œç¨‹åº"
        Write-Output "   2. ä½¿ç”¨ å¯åŠ¨PD-Signal.bat å¯æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º"
        Write-Output "   3. é˜…è¯» ä½¿ç”¨è¯´æ˜.txt äº†è§£è¯¦ç»†ç”¨æ³•"
        Write-Output "   4. æŸ¥çœ‹ ä¿®å¤è¯´æ˜.txt äº†è§£ä¿®å¤è¯¦æƒ…"
        Write-Output "=========================================="
