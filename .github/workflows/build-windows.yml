name: æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶

on:
  push:
    branches: [ main, master, Cookie ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        # å®‰è£…Windowsæ„å»ºå·¥å…·
        python -m pip install --upgrade pip
        python -m pip install wheel setuptools
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller
        
    - name: éªŒè¯ä¾èµ–å®‰è£…
      run: |
        python -c "import flet; print('Fletç‰ˆæœ¬:', flet.__version__)"
        python -c "import requests; print('Requestsç‰ˆæœ¬:', requests.__version__)"
        python -c "import plyer; print('Plyerå·²å®‰è£…')"
        pyinstaller --version
        
    - name: æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
      run: |
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
        
    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        python build.py
        
    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        if (Test-Path "dist\PD-Signal.exe") {
          Write-Output "âœ… å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          $fileSize = (Get-Item "dist\PD-Signal.exe").Length / 1MB
          Write-Output "æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Output "âŒ å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        if (-not (Test-Path "release")) { New-Item -ItemType Directory "release" }
        if (Test-Path "release\PD-Signal") { Remove-Item -Recurse -Force "release\PD-Signal" }
        New-Item -ItemType Directory "release\PD-Signal"
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        Copy-Item "dist\PD-Signal.exe" "release\PD-Signal\"
        Copy-Item "dist\å¯åŠ¨PD-Signal.bat" "release\PD-Signal\"
        Copy-Item "dist\ä½¿ç”¨è¯´æ˜.txt" "release\PD-Signal\"
        
        # å¤åˆ¶æºç 
        New-Item -ItemType Directory "release\PD-Signal\source"
        Copy-Item "*.py" "release\PD-Signal\source\"
        Copy-Item "requirements.txt" "release\PD-Signal\source\"
        Copy-Item "README_CN.md" "release\PD-Signal\source\"
        Copy-Item "project_overview.md" "release\PD-Signal\source\"
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        $versionInfo = @"
PD Signal - PandaLiveç›‘æ§å·¥å…·
ç‰ˆæœ¬: 1.0.0
æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
æ„å»ºç¯å¢ƒ: GitHub Actions
Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}
"@
        $versionInfo | Out-File -FilePath "release\PD-Signal\ç‰ˆæœ¬ä¿¡æ¯.txt" -Encoding UTF8
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Windows-${{ github.run_number }}
        path: |
          dist/
          release/
        retention-days: 30
        
    - name: åˆ›å»ºå‘å¸ƒ (ä»…æ ‡ç­¾æ¨é€æ—¶)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/PD-Signal.exe
          dist/å¯åŠ¨PD-Signal.bat
          dist/ä½¿ç”¨è¯´æ˜.txt
          release/PD-Signal/ç‰ˆæœ¬ä¿¡æ¯.txt
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¾“å‡ºæ„å»ºä¿¡æ¯
      shell: pwsh
      run: |
        Write-Output "=========================================="
        Write-Output "ğŸ‰ æ„å»ºå®Œæˆï¼"
        Write-Output "=========================================="
        Write-Output "ğŸ“ æ„å»ºäº§ç‰©:"
        Get-ChildItem "dist" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Output "   - $($_.Name) ($([math]::Round($size, 2)) MB)"
        }
        Write-Output ""
        Write-Output "ğŸ“¦ å‘å¸ƒåŒ…:"
        Get-ChildItem "release\PD-Signal" | ForEach-Object {
          Write-Output "   - $($_.Name)"
        }
        Write-Output ""
        Write-Output "ğŸ’¡ ä½¿ç”¨è¯´æ˜:"
        Write-Output "   1. ä¸‹è½½ PD-Signal.exe è¿è¡Œç¨‹åº"
        Write-Output "   2. ä½¿ç”¨ å¯åŠ¨PD-Signal.bat å¯æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º"
        Write-Output "   3. é˜…è¯» ä½¿ç”¨è¯´æ˜.txt äº†è§£è¯¦ç»†ç”¨æ³•"
