name: å¼€å‘æµ‹è¯•æ„å»º

on:
  push:
    branches: [ Cookie ]
  pull_request:
    branches: [ Cookie ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test-and-build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: è®¾ç½®UTF-8ç¼–ç ç¯å¢ƒ
      run: echo PYTHONIOENCODING=utf-8 >> $env:GITHUB_ENV
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller pytest
        
    - name: è¿è¡ŒåŸºç¡€æµ‹è¯•
      shell: pwsh
      run: |
        Write-Output "ğŸ§ª å¼€å§‹è¿è¡ŒåŸºç¡€æµ‹è¯•..."
        
        # æµ‹è¯•Pythonæ¨¡å—å¯¼å…¥
        python -c "import main; print('âœ… mainæ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import database_manager; print('âœ… database_manageræ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import notification_manager; print('âœ… notification_manageræ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import panda_monitor; print('âœ… panda_monitoræ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import config; print('âœ… configæ¨¡å—å¯¼å…¥æˆåŠŸ')"
        
        # æµ‹è¯•ä¾èµ–åº“
        python -c "import flet; print('âœ… Fletç‰ˆæœ¬:', flet.__version__)"
        python -c "import requests; print('âœ… Requestsç‰ˆæœ¬:', requests.__version__)"
        python -c "import plyer; print('âœ… Plyerå·²å®‰è£…')"
        python -c "import urllib3; print('âœ… urllib3ç‰ˆæœ¬:', urllib3.__version__)"
        python -c "import certifi; print('âœ… certifiå·²å®‰è£…')"
        python -c "import charset_normalizer; print('âœ… charset_normalizerå·²å®‰è£…')"
        python -c "import idna; print('âœ… idnaç‰ˆæœ¬:', idna.__version__)"
        
        Write-Output "ğŸ‰ æ‰€æœ‰åŸºç¡€æµ‹è¯•é€šè¿‡ï¼"
        
    - name: æ¸…ç†æ„å»ºç¯å¢ƒ
      run: |
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
        
    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      shell: pwsh
      run: |
        Write-Output "ğŸ”¨ å¼€å§‹æ„å»ºæµ‹è¯•ç‰ˆæœ¬..."
        Write-Output "åˆ†æ”¯: ${{ github.ref_name }}"
        Write-Output "æäº¤: ${{ github.sha }}"
        Write-Output ""
        python build_fixed.py
        
    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        if (Test-Path "dist\PD-Signal\PD-Signal.exe") {
          Write-Output "âœ… æµ‹è¯•ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          $fileSize = (Get-Item "dist\PD-Signal\PD-Signal.exe").Length / 1MB
          Write-Output "æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
          
          # æ£€æŸ¥_internalæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
          if (Test-Path "dist\PD-Signal\_internal") {
            Write-Output "âœ… _internalä¾èµ–æ–‡ä»¶å¤¹å­˜åœ¨"
            $internalSize = (Get-ChildItem "dist\PD-Signal\_internal" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Output "_internalæ–‡ä»¶å¤¹å¤§å°: $([math]::Round($internalSize, 2)) MB"
          } else {
            Write-Output "âš ï¸ _internalä¾èµ–æ–‡ä»¶å¤¹ä¸å­˜åœ¨"
          }
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ
          $fileInfo = Get-Item "dist\PD-Signal\PD-Signal.exe"
          Write-Output "æ–‡ä»¶ç‰ˆæœ¬: $($fileInfo.VersionInfo.FileVersion)"
          Write-Output "åˆ›å»ºæ—¶é—´: $($fileInfo.CreationTime)"
          Write-Output "ä¿®æ”¹æ—¶é—´: $($fileInfo.LastWriteTime)"
        } else {
          Write-Output "âŒ æµ‹è¯•ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: åˆ›å»ºæµ‹è¯•ç‰ˆå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        $releaseDir = "release\PD-Signal-Test"
        if (Test-Path $releaseDir) { Remove-Item -Recurse -Force $releaseDir }
        New-Item -ItemType Directory $releaseDir
        
        # å¤åˆ¶æ•´ä¸ªPD-Signalç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
        Copy-Item "dist\PD-Signal" "$releaseDir\" -Recurse
        
        # å¤åˆ¶ä½¿ç”¨è¯´æ˜
        Copy-Item "dist\ä½¿ç”¨è¯´æ˜.txt" "$releaseDir\" -ErrorAction SilentlyContinue
        
        # å¤åˆ¶æºç å’Œæ–‡æ¡£
        New-Item -ItemType Directory "$releaseDir\source"
        Copy-Item "*.py" "$releaseDir\source\"
        Copy-Item "requirements.txt" "$releaseDir\source\"
        Copy-Item "README_CN.md" "$releaseDir\source\"
        Copy-Item "project_overview.md" "$releaseDir\source\"
        
        # åˆ›å»ºæµ‹è¯•è¯´æ˜
        $testInfo = "PD Signal - PandaLiveç›‘æ§å·¥å…· (æµ‹è¯•ç‰ˆ)`nç‰ˆæœ¬: æµ‹è¯•ç‰ˆ`næ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`næ„å»ºç¯å¢ƒ: GitHub Actions Windows (æµ‹è¯•)`nPythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}`nGitæäº¤: ${{ github.sha }}`nåˆ†æ”¯: ${{ github.ref_name }}`n`nğŸ§ª æµ‹è¯•è¯´æ˜:`n- è¿™æ˜¯å¼€å‘æµ‹è¯•ç‰ˆæœ¬`n- ç”¨äºéªŒè¯æ„å»ºæµç¨‹å’ŒåŸºæœ¬åŠŸèƒ½`n- å¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½æˆ–å·²çŸ¥é—®é¢˜`n- ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨`n`nâœ… æµ‹è¯•å†…å®¹:`n- Pythonæ¨¡å—å¯¼å…¥æµ‹è¯•`n- ä¾èµ–åº“ç‰ˆæœ¬æ£€æŸ¥`n- å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæµ‹è¯•`n- æ–‡ä»¶å®Œæ•´æ€§éªŒè¯`n- _internalä¾èµ–æ–‡ä»¶å¤¹æ£€æŸ¥`n`nğŸ“ æ–‡ä»¶ç»“æ„:`n- PD-Signal.exe (ä¸»ç¨‹åº)`n- _internal/ (æ‰€æœ‰ä¾èµ–æ–‡ä»¶)`n- ä½¿ç”¨è¯´æ˜.txt (ä½¿ç”¨è¯´æ˜)`n- source/ (æºä»£ç )`n`nğŸ’¡ ä½¿ç”¨è¯´æ˜:`n1. ç›´æ¥è¿è¡Œ PD-Signal.exe å¯åŠ¨ç¨‹åº`n2. ç¨‹åºåŒ…å«æ‰€æœ‰ä¾èµ–ï¼Œæ— éœ€é¢å¤–å®‰è£…`n3. å·²ä¿®å¤é‡å¤åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜`n4. æ”¯æŒå•å®ä¾‹è¿è¡Œï¼Œé¿å…å¤šå¼€"
        $testInfo | Out-File -FilePath "$releaseDir\æµ‹è¯•è¯´æ˜.txt" -Encoding UTF8
        
    - name: ä¸Šä¼ æµ‹è¯•ç‰ˆæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Test-${{ github.run_number }}
        path: |
          dist/
          release/PD-Signal-Test/
        retention-days: 7  # æµ‹è¯•ç‰ˆæœ¬åªä¿ç•™7å¤©
        
    - name: è¾“å‡ºæµ‹è¯•ä¿¡æ¯
      shell: pwsh
      run: |
        Write-Output "=========================================="
        Write-Output "ğŸ‰ æµ‹è¯•æ„å»ºå®Œæˆï¼"
        Write-Output "=========================================="
        Write-Output "ğŸ“ æ„å»ºäº§ç‰©:"
        Get-ChildItem "dist" | ForEach-Object {
          if ($_.PSIsContainer) {
            Write-Output "   - $($_.Name)/ (ç›®å½•)"
            # åˆ—å‡ºç›®å½•ä¸­çš„ä¸»è¦æ–‡ä»¶
            try {
              Get-ChildItem $_.FullName | ForEach-Object {
                if ($_.PSIsContainer) {
                  Write-Output "     - $($_.Name)/ (å­ç›®å½•)"
                } else {
                  $size = $_.Length / 1MB
                  Write-Output "     - $($_.Name) ($([math]::Round($size, 2)) MB)"
                }
              }
            } catch {
              Write-Output "     - (æ— æ³•è®¿é—®ç›®å½•å†…å®¹)"
            }
          } else {
            $size = $_.Length / 1MB
            Write-Output "   - $($_.Name) ($([math]::Round($size, 2)) MB)"
          }
        }
        Write-Output ""
        Write-Output "ğŸ“¦ æµ‹è¯•ç‰ˆå‘å¸ƒåŒ…:"
        Get-ChildItem "release\PD-Signal-Test" | ForEach-Object {
          Write-Output "   - $($_.Name)"
        }
        Write-Output ""
        Write-Output "ğŸ§ª æµ‹è¯•å†…å®¹:"
        Write-Output "   - Pythonæ¨¡å—å¯¼å…¥æµ‹è¯•"
        Write-Output "   - ä¾èµ–åº“ç‰ˆæœ¬æ£€æŸ¥"
        Write-Output "   - å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæµ‹è¯•"
        Write-Output "   - æ–‡ä»¶å®Œæ•´æ€§éªŒè¯"
        Write-Output ""
        Write-Output "ğŸ’¡ ä½¿ç”¨è¯´æ˜:"
        Write-Output "   1. è¿™æ˜¯æµ‹è¯•ç‰ˆæœ¬ï¼Œç”¨äºéªŒè¯æ„å»ºæµç¨‹"
        Write-Output "   2. è¿è¡Œ PD-Signal/PD-Signal.exe è¿›è¡Œæµ‹è¯•"
        Write-Output "   3. ç¨‹åºåŒ…å«æ‰€æœ‰ä¾èµ–ï¼Œæ— éœ€é¢å¤–å®‰è£…"
        Write-Output "   4. å·²ä¿®å¤é‡å¤åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜"
        Write-Output "   5. æŸ¥çœ‹ æµ‹è¯•è¯´æ˜.txt äº†è§£æµ‹è¯•è¯¦æƒ…"
        Write-Output "=========================================="
