name: Windowsæ„å»ºæµ‹è¯•

on:
  push:
    branches: [ Cookie, test ]
  pull_request:
    branches: [ Cookie ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test-and-build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: è®¾ç½®UTF-8ç¼–ç ç¯å¢ƒ
      run: echo PYTHONIOENCODING=utf-8 >> $env:GITHUB_ENV
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller pytest
        
    - name: è¿è¡ŒåŸºç¡€æµ‹è¯•
      shell: pwsh
      run: |
        # æµ‹è¯•Pythonæ¨¡å—å¯¼å…¥
        python -c "import main; print('âœ… mainæ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import database_manager; print('âœ… database_manageræ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import notification_manager; print('âœ… notification_manageræ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import panda_monitor; print('âœ… panda_monitoræ¨¡å—å¯¼å…¥æˆåŠŸ')"
        python -c "import config; print('âœ… configæ¨¡å—å¯¼å…¥æˆåŠŸ')"
        
        # æµ‹è¯•ä¾èµ–åº“
        python -c "import flet; print('âœ… Fletç‰ˆæœ¬:', flet.__version__)"
        python -c "import requests; print('âœ… Requestsç‰ˆæœ¬:', requests.__version__)"
        python -c "import plyer; print('âœ… Plyerå·²å®‰è£…')"
        
    - name: æ¸…ç†æ„å»ºç¯å¢ƒ
      run: |
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
        
    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      shell: pwsh
      run: |
        Write-Output "å¼€å§‹æ„å»º..."
        python build.py
        
    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        if (Test-Path "dist\PD-Signal.exe") {
          Write-Output "âœ… æ„å»ºæˆåŠŸï¼"
          $fileSize = (Get-Item "dist\PD-Signal.exe").Length / 1MB
          Write-Output "æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
          
          # æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯
          $fileInfo = Get-Item "dist\PD-Signal.exe"
          Write-Output "åˆ›å»ºæ—¶é—´: $($fileInfo.CreationTime)"
          Write-Output "ä¿®æ”¹æ—¶é—´: $($fileInfo.LastWriteTime)"
        } else {
          Write-Output "âŒ æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Test-Build-${{ github.run_number }}
        path: dist/
        retention-days: 7
        
    - name: è¾“å‡ºæ„å»ºä¿¡æ¯
      shell: pwsh
      run: |
        Write-Output "=========================================="
        Write-Output "ğŸ‰ æµ‹è¯•æ„å»ºå®Œæˆï¼"
        Write-Output "=========================================="
        Write-Output "åˆ†æ”¯: ${{ github.ref_name }}"
        Write-Output "æäº¤: ${{ github.sha }}"
        Write-Output "Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}"
        Write-Output "=========================================="
