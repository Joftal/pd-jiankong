name: Build PD Signal

on:
  push:
    branches: [ main, master, Cookie ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # ä½¿ç”¨ç¨³å®šçš„Pythonç‰ˆæœ¬
        
    - name: Debug environment
      run: |
        echo "ğŸ” è°ƒè¯•ç¯å¢ƒä¿¡æ¯..."
        echo "Pythonç‰ˆæœ¬:"
        python --version
        echo "Pythonè·¯å¾„:"
        where python
        echo "å½“å‰å·¥ä½œç›®å½•:"
        cd
        echo "æ–‡ä»¶åˆ—è¡¨:"
        dir
        echo "âœ… ç¯å¢ƒè°ƒè¯•å®Œæˆ"
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        echo "ğŸ”§ å¼€å§‹å®‰è£…ä¾èµ–é¡¹..."
        python -m pip install --upgrade pip || { echo "âŒ pipå‡çº§å¤±è´¥"; exit 1; }
        pip install -r requirements.txt || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
        pip install pyinstaller || { echo "âŒ PyInstallerå®‰è£…å¤±è´¥"; exit 1; }
        echo "âœ… ä¾èµ–é¡¹å®‰è£…å®Œæˆ"
        
    - name: Verify installation
      run: |
        python --version
        pip list | findstr -i "flet requests plyer pyinstaller"
      shell: cmd
        
    - name: Clean previous builds
      run: |
        if exist "build" rmdir /s /q "build"
        if exist "dist" rmdir /s /q "dist"
        if exist "*.spec" del /q "*.spec"
      shell: cmd
        
    - name: Build executable
      run: |
        python build_github_action.py
        
    - name: Verify build output
      run: |
        echo "Checking build output..."
        if exist "dist\PD-Signal\PD-Signal.exe" (
          echo "âœ… Main executable found"
          dir "dist\PD-Signal\PD-Signal.exe"
        ) else (
          echo "âŒ Main executable not found"
          exit 1
        )
        
        if exist "dist\å¯åŠ¨PD-Signal.bat" (
          echo "âœ… Startup script found"
        ) else (
          echo "âŒ Startup script not found"
          exit 1
        )
        
        if exist "dist\ä½¿ç”¨è¯´æ˜.txt" (
          echo "âœ… Readme found"
        ) else (
          echo "âŒ Readme not found"
          exit 1
        )
      shell: cmd
        
    - name: Create release package
      run: |
        echo "Creating release package..."
        if not exist "release" mkdir "release"
        if exist "release\PD-Signal-GitHub" rmdir /s /q "release\PD-Signal-GitHub"
        mkdir "release\PD-Signal-GitHub"
        
        REM Copy main executable and dependencies
        xcopy "dist\PD-Signal\*" "release\PD-Signal-GitHub\" /E /I /Y
        
        REM Copy additional files
        copy "dist\å¯åŠ¨PD-Signal.bat" "release\PD-Signal-GitHub\"
        copy "dist\è°ƒè¯•æ¨¡å¼.bat" "release\PD-Signal-GitHub\"
        copy "dist\ä½¿ç”¨è¯´æ˜.txt" "release\PD-Signal-GitHub\"
        
        REM Copy source code
        mkdir "release\PD-Signal-GitHub\source"
        copy "*.py" "release\PD-Signal-GitHub\source\"
        copy "requirements.txt" "release\PD-Signal-GitHub\source\"
        copy "README*.md" "release\PD-Signal-GitHub\source\"
        
        echo "Release package created successfully"
        dir "release\PD-Signal-GitHub" /b
      shell: cmd
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Windows-${{ github.run_number }}
        path: |
          release/PD-Signal-GitHub/
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/PD-Signal-GitHub/PD-Signal.exe
          release/PD-Signal-GitHub/å¯åŠ¨PD-Signal.bat
          release/PD-Signal-GitHub/è°ƒè¯•æ¨¡å¼.bat
          release/PD-Signal-GitHub/ä½¿ç”¨è¯´æ˜.txt
        body: |
          ## PD Signal - PandaLiveç›‘æ§å·¥å…·
          
          ### åŠŸèƒ½ç‰¹ç‚¹
          - âœ… æ”¯æŒå¤šä¸»æ’­åŒæ—¶ç›‘æ§
          - âœ… å®æ—¶å¼€æ’­/ä¸‹æ’­é€šçŸ¥
          - âœ… Windowsç³»ç»Ÿé€šçŸ¥
          - âœ… æ•°æ®æŒä¹…åŒ–å­˜å‚¨
          - âœ… ç°ä»£åŒ–GUIç•Œé¢
          - âœ… é…ç½®è‡ªåŠ¨ä¿å­˜
          
          ### ä½¿ç”¨è¯´æ˜
          1. è¿è¡Œ `PD-Signal.exe` å¯åŠ¨ç¨‹åº
          2. ä½¿ç”¨ `å¯åŠ¨PD-Signal.bat` å¯ä»¥æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
          3. ä½¿ç”¨ `è°ƒè¯•æ¨¡å¼.bat` å¯ä»¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
          4. é˜…è¯» `ä½¿ç”¨è¯´æ˜.txt` äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•
          
          ### æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Debug environment
      run: |
        set -x
        echo "ğŸ” è°ƒè¯•ç¯å¢ƒä¿¡æ¯..."
        echo "Pythonç‰ˆæœ¬:"
        python --version
        echo "Pythonè·¯å¾„:"
        which python
        echo "å½“å‰å·¥ä½œç›®å½•:"
        pwd
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "âœ… ç¯å¢ƒè°ƒè¯•å®Œæˆ"
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        set -x
        echo "ğŸ”§ å¼€å§‹å®‰è£…ä¾èµ–é¡¹..."
        python -m pip install --upgrade pip || { echo "âŒ pipå‡çº§å¤±è´¥"; exit 1; }
        pip install -r requirements.txt || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
        pip install pyinstaller || { echo "âŒ PyInstallerå®‰è£…å¤±è´¥"; exit 1; }
        echo "âœ… ä¾èµ–é¡¹å®‰è£…å®Œæˆ"
        
    - name: Verify installation
      run: |
        python --version
        pip list | grep -i "flet requests plyer pyinstaller"
        
    - name: Clean previous builds
      run: |
        rm -rf build dist *.spec
        
    - name: Build executable
      run: |
        python build_github_action.py
        
    - name: Verify build output
      run: |
        echo "Checking build output..."
        if [ -f "dist/PD-Signal/PD-Signal" ]; then
          echo "âœ… Main executable found"
          ls -la "dist/PD-Signal/PD-Signal"
        else
          echo "âŒ Main executable not found"
          exit 1
        fi
        
    - name: Create release package
      run: |
        echo "Creating release package..."
        mkdir -p release/PD-Signal-Linux
        
        # Copy main executable and dependencies
        cp -r dist/PD-Signal/* release/PD-Signal-Linux/
        
        # Copy additional files
        cp dist/å¯åŠ¨PD-Signal.bat release/PD-Signal-Linux/ 2>/dev/null || true
        cp dist/è°ƒè¯•æ¨¡å¼.bat release/PD-Signal-Linux/ 2>/dev/null || true
        cp dist/ä½¿ç”¨è¯´æ˜.txt release/PD-Signal-Linux/
        
        # Copy source code
        mkdir -p release/PD-Signal-Linux/source
        cp *.py release/PD-Signal-Linux/source/
        cp requirements.txt release/PD-Signal-Linux/source/
        cp README*.md release/PD-Signal-Linux/source/ 2>/dev/null || true
        
        echo "Release package created successfully"
        ls -la release/PD-Signal-Linux/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Linux-${{ github.run_number }}
        path: |
          release/PD-Signal-Linux/
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Debug environment
      run: |
        set -x
        echo "ğŸ” è°ƒè¯•ç¯å¢ƒä¿¡æ¯..."
        echo "Pythonç‰ˆæœ¬:"
        python --version
        echo "Pythonè·¯å¾„:"
        which python
        echo "å½“å‰å·¥ä½œç›®å½•:"
        pwd
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "âœ… ç¯å¢ƒè°ƒè¯•å®Œæˆ"
        
    - name: Install system dependencies (macOS)
      run: |
        set -x
        echo "ğŸ”§ å®‰è£…macOSç³»ç»Ÿä¾èµ–..."
        # å®‰è£…Xcodeå‘½ä»¤è¡Œå·¥å…·ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
        xcode-select --install 2>/dev/null || echo "Xcodeå‘½ä»¤è¡Œå·¥å…·å·²å®‰è£…"
        # å®‰è£…å¿…è¦çš„ç³»ç»Ÿåº“
        brew install --quiet libffi || echo "libffiå·²å®‰è£…æˆ–å®‰è£…å¤±è´¥"
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        set -x
        echo "ğŸ”§ å¼€å§‹å®‰è£…ä¾èµ–é¡¹..."
        python -m pip install --upgrade pip || { echo "âŒ pipå‡çº§å¤±è´¥"; exit 1; }
        pip install -r requirements.txt || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
        pip install pyinstaller || { echo "âŒ PyInstallerå®‰è£…å¤±è´¥"; exit 1; }
        echo "âœ… ä¾èµ–é¡¹å®‰è£…å®Œæˆ"
        
    - name: Verify installation
      run: |
        set -x
        echo "ğŸ” éªŒè¯å®‰è£…..."
        python --version
        pip list | grep -i "flet requests plyer pyinstaller"
        echo "âœ… å®‰è£…éªŒè¯å®Œæˆ"
        
    - name: Clean previous builds
      run: |
        set -x
        echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»º..."
        rm -rf build dist *.spec
        echo "âœ… æ¸…ç†å®Œæˆ"
        
    - name: Build executable
      run: |
        set -x
        echo "ğŸ”¨ å¼€å§‹æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶..."
        python build_github_action.py || { echo "âŒ æ„å»ºè„šæœ¬å¤±è´¥"; exit 1; }
        echo "âœ… æ„å»ºå®Œæˆ"
        
    - name: Verify build output
      run: |
        set -x
        echo "ğŸ” æ£€æŸ¥æ„å»ºè¾“å‡º..."
        if [ -f "dist/PD-Signal/PD-Signal" ]; then
          echo "âœ… ä¸»å¯æ‰§è¡Œæ–‡ä»¶å·²æ‰¾åˆ°"
          ls -la "dist/PD-Signal/PD-Signal"
          file "dist/PD-Signal/PD-Signal"
        else
          echo "âŒ ä¸»å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
          echo "ğŸ“ æ£€æŸ¥distç›®å½•å†…å®¹:"
          ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"
          echo "ğŸ“ æ£€æŸ¥PD-Signalç›®å½•å†…å®¹:"
          ls -la dist/PD-Signal/ || echo "PD-Signalç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Create release package
      run: |
        set -x
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
        mkdir -p release/PD-Signal-macOS
        
        # Copy main executable and dependencies
        cp -r dist/PD-Signal/* release/PD-Signal-macOS/
        
        # Copy additional files
        cp dist/ä½¿ç”¨è¯´æ˜.txt release/PD-Signal-macOS/ || echo "âš ï¸ ä½¿ç”¨è¯´æ˜.txtæœªæ‰¾åˆ°"
        
        # Copy source code
        mkdir -p release/PD-Signal-macOS/source
        cp *.py release/PD-Signal-macOS/source/
        cp requirements.txt release/PD-Signal-macOS/source/
        cp README*.md release/PD-Signal-macOS/source/ 2>/dev/null || echo "âš ï¸ READMEæ–‡ä»¶æœªæ‰¾åˆ°"
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºæˆåŠŸ"
        ls -la release/PD-Signal-macOS/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-macOS-${{ github.run_number }}
        path: |
          release/PD-Signal-macOS/
        retention-days: 30
