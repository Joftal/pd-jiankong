name: å¤šå¹³å°æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main, master, Cookie ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      platform:
        description: 'é€‰æ‹©æ„å»ºå¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - windows
        - linux
        - macos

env:
  PYTHON_VERSION: '3.11'
  BUILD_VERSION: ${{ github.ref_name || 'dev' }}

jobs:
  build-windows:
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows' || github.event.inputs.platform == ''
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…æ„å»ºä¾èµ–
      run: |
        python -m pip install --upgrade pip wheel setuptools
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller
        
    - name: éªŒè¯ç¯å¢ƒ
      shell: pwsh
      run: |
        python --version
        python -c "import sys; print('Pythonè·¯å¾„:', sys.executable)"
        pyinstaller --version
        
    - name: æ¸…ç†æ„å»ºç¯å¢ƒ
      run: |
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
        
    - name: æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶
      shell: pwsh
      run: |
        Write-Output "å¼€å§‹æ„å»ºWindowsç‰ˆæœ¬..."
        python build.py
        
    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        if (Test-Path "dist\PD-Signal.exe") {
          Write-Output "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          $fileSize = (Get-Item "dist\PD-Signal.exe").Length / 1MB
          Write-Output "æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ
          $fileInfo = Get-Item "dist\PD-Signal.exe"
          Write-Output "æ–‡ä»¶ç‰ˆæœ¬: $($fileInfo.VersionInfo.FileVersion)"
        } else {
          Write-Output "âŒ Windowså¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: åˆ›å»ºWindowså‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        $releaseDir = "release\PD-Signal-Windows"
        if (Test-Path $releaseDir) { Remove-Item -Recurse -Force $releaseDir }
        New-Item -ItemType Directory $releaseDir
        
        # å¤åˆ¶ä¸»è¦æ–‡ä»¶
        Copy-Item "dist\PD-Signal.exe" "$releaseDir\"
        Copy-Item "dist\å¯åŠ¨PD-Signal.bat" "$releaseDir\"
        Copy-Item "dist\ä½¿ç”¨è¯´æ˜.txt" "$releaseDir\"
        
        # å¤åˆ¶æºç å’Œæ–‡æ¡£
        New-Item -ItemType Directory "$releaseDir\source"
        Copy-Item "*.py" "$releaseDir\source\"
        Copy-Item "requirements.txt" "$releaseDir\source\"
        Copy-Item "README_CN.md" "$releaseDir\source\"
        Copy-Item "project_overview.md" "$releaseDir\source\"
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        $versionInfo = "PD Signal - PandaLiveç›‘æ§å·¥å…· (Windowsç‰ˆ)`nç‰ˆæœ¬: ${{ env.BUILD_VERSION }}`næ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`næ„å»ºç¯å¢ƒ: GitHub Actions Windows`nPythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}`nGitæäº¤: ${{ github.sha }}"
        $versionInfo | Out-File -FilePath "$releaseDir\ç‰ˆæœ¬ä¿¡æ¯.txt" -Encoding UTF8
        
        # åˆ›å»ºå®‰è£…è¯´æ˜
        $installGuide = "# PD Signal Windowsç‰ˆå®‰è£…è¯´æ˜`n`n## ç³»ç»Ÿè¦æ±‚`n- Windows 10/11 (64ä½)`n- æ— éœ€å®‰è£…Pythonæˆ–å…¶ä»–ä¾èµ–`n`n## å®‰è£…æ­¥éª¤`n1. ä¸‹è½½ PD-Signal.exe`n2. åŒå‡»è¿è¡Œå³å¯`n3. é¦–æ¬¡ä½¿ç”¨è¯·è®¾ç½®PandaLive Cookie`n`n## ä½¿ç”¨è¯´æ˜`n- è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹`"ä½¿ç”¨è¯´æ˜.txt`"`n- å¦‚æœ‰é—®é¢˜å¯æŸ¥çœ‹`"ç‰ˆæœ¬ä¿¡æ¯.txt`"`n`n## æŠ€æœ¯æ”¯æŒ`n- GitHub: ${{ github.repository }}`n- æäº¤: ${{ github.sha }}"
        $installGuide | Out-File -FilePath "$releaseDir\å®‰è£…è¯´æ˜.md" -Encoding UTF8
        
    - name: ä¸Šä¼ Windowsæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Windows-${{ github.run_number }}
        path: |
          dist/
          release/PD-Signal-Windows/
        retention-days: 30

  build-linux:
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux'
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libffi-dev python3-dev
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip wheel setuptools
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller
        
    - name: æ„å»ºLinuxå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        echo "å¼€å§‹æ„å»ºLinuxç‰ˆæœ¬..."
        pyinstaller --onefile --name=PD-Signal --distpath=dist --workpath=build --clean main.py
        
    - name: éªŒè¯Linuxæ„å»ºç»“æœ
      run: |
        if [ -f "dist/PD-Signal" ]; then
          echo "âœ… Linuxå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          ls -lh dist/PD-Signal
          file dist/PD-Signal
        else
          echo "âŒ Linuxå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: åˆ›å»ºLinuxå‘å¸ƒåŒ…
      run: |
        mkdir -p release/PD-Signal-Linux
        cp dist/PD-Signal release/PD-Signal-Linux/
        cp *.py release/PD-Signal-Linux/source/ 2>/dev/null || true
        cp requirements.txt release/PD-Signal-Linux/source/
        cp README_CN.md release/PD-Signal-Linux/source/
        
        echo "PD Signal - PandaLiveç›‘æ§å·¥å…· (Linuxç‰ˆ)" > release/PD-Signal-Linux/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "ç‰ˆæœ¬: ${{ env.BUILD_VERSION }}" >> release/PD-Signal-Linux/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> release/PD-Signal-Linux/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "æ„å»ºç¯å¢ƒ: GitHub Actions Ubuntu" >> release/PD-Signal-Linux/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}" >> release/PD-Signal-Linux/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "Gitæäº¤: ${{ github.sha }}" >> release/PD-Signal-Linux/ç‰ˆæœ¬ä¿¡æ¯.txt
        
    - name: ä¸Šä¼ Linuxæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-Linux-${{ github.run_number }}
        path: |
          dist/
          release/PD-Signal-Linux/
        retention-days: 30

  build-macos:
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos'
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip wheel setuptools
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller
        
    - name: æ„å»ºmacOSå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        echo "å¼€å§‹æ„å»ºmacOSç‰ˆæœ¬..."
        pyinstaller --onefile --name=PD-Signal --distpath=dist --workpath=build --clean main.py
        
    - name: éªŒè¯macOSæ„å»ºç»“æœ
      run: |
        if [ -f "dist/PD-Signal" ]; then
          echo "âœ… macOSå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          ls -lh dist/PD-Signal
          file dist/PD-Signal
        else
          echo "âŒ macOSå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: åˆ›å»ºmacOSå‘å¸ƒåŒ…
      run: |
        mkdir -p release/PD-Signal-macOS
        cp dist/PD-Signal release/PD-Signal-macOS/
        cp *.py release/PD-Signal-macOS/source/ 2>/dev/null || true
        cp requirements.txt release/PD-Signal-macOS/source/
        cp README_CN.md release/PD-Signal-macOS/source/
        
        echo "PD Signal - PandaLiveç›‘æ§å·¥å…· (macOSç‰ˆ)" > release/PD-Signal-macOS/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "ç‰ˆæœ¬: ${{ env.BUILD_VERSION }}" >> release/PD-Signal-macOS/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> release/PD-Signal-macOS/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "æ„å»ºç¯å¢ƒ: GitHub Actions macOS" >> release/PD-Signal-macOS/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}" >> release/PD-Signal-macOS/ç‰ˆæœ¬ä¿¡æ¯.txt
        echo "Gitæäº¤: ${{ github.sha }}" >> release/PD-Signal-macOS/ç‰ˆæœ¬ä¿¡æ¯.txt
        
    - name: ä¸Šä¼ macOSæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PD-Signal-macOS-${{ github.run_number }}
        path: |
          dist/
          release/PD-Signal-macOS/
        retention-days: 30

  create-release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: |
          PD-Signal-Windows-*/dist/PD-Signal.exe
          PD-Signal-Windows-*/release/PD-Signal-Windows/*
          PD-Signal-Linux-*/dist/PD-Signal
          PD-Signal-Linux-*/release/PD-Signal-Linux/*
          PD-Signal-macOS-*/dist/PD-Signal
          PD-Signal-macOS-*/release/PD-Signal-macOS/*
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## PD Signal v${{ github.ref_name }}
          
          ### ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `PD-Signal.exe` ç›´æ¥è¿è¡Œ
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `PD-Signal` å¹¶æ·»åŠ æ‰§è¡Œæƒé™ (`chmod +x PD-Signal`)
          - **macOSç”¨æˆ·**: ä¸‹è½½ `PD-Signal` å¹¶æ·»åŠ æ‰§è¡Œæƒé™ (`chmod +x PD-Signal`)
          
          ### åŠŸèƒ½ç‰¹ç‚¹
          - âœ… å¤šä¸»æ’­ç›‘æ§
          - âœ… å®æ—¶é€šçŸ¥
          - âœ… è·¨å¹³å°æ”¯æŒ
          - âœ… ç°ä»£åŒ–GUIç•Œé¢
          
          ### ä½¿ç”¨è¯´æ˜
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹å„å¹³å°å‘å¸ƒåŒ…ä¸­çš„è¯´æ˜æ–‡æ¡£ã€‚
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¾“å‡ºå‘å¸ƒä¿¡æ¯
      run: |
        echo "=========================================="
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
        echo "=========================================="
        echo "ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "å¹³å°: Windows, Linux, macOS"
        echo "=========================================="
