name: Windowså‘å¸ƒæ„å»º

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  BUILD_VERSION: ${{ github.ref_name || 'dev' }}

jobs:
  build-windows-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: è®¾ç½®UTF-8ç¼–ç ç¯å¢ƒ
      run: echo PYTHONIOENCODING=utf-8 >> $env:GITHUB_ENV
        
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…æ„å»ºä¾èµ–
      run: |
        python -m pip install --upgrade pip wheel setuptools
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller
        
    - name: éªŒè¯ç¯å¢ƒ
      shell: pwsh
      run: |
        python --version
        python -c "import sys; print('Pythonè·¯å¾„:', sys.executable)"
        pyinstaller --version
        
    - name: æ¸…ç†æ„å»ºç¯å¢ƒ
      run: |
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
        
    - name: æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶
      shell: pwsh
      run: |
        Write-Output "ğŸ”¨ å¼€å§‹æ„å»ºWindowså‘å¸ƒç‰ˆæœ¬..."
        Write-Output "ç‰ˆæœ¬: ${{ env.BUILD_VERSION }}"
        Write-Output "æäº¤: ${{ github.sha }}"
        Write-Output ""
        python build_fixed.py
        
    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        if (Test-Path "dist\PD-Signal\PD-Signal.exe") {
          Write-Output "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          $fileSize = (Get-Item "dist\PD-Signal\PD-Signal.exe").Length / 1MB
          Write-Output "æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
          
          # æ£€æŸ¥_internalæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
          if (Test-Path "dist\PD-Signal\_internal") {
            Write-Output "âœ… _internalä¾èµ–æ–‡ä»¶å¤¹å­˜åœ¨"
            $internalSize = (Get-ChildItem "dist\PD-Signal\_internal" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Output "_internalæ–‡ä»¶å¤¹å¤§å°: $([math]::Round($internalSize, 2)) MB"
          } else {
            Write-Output "âš ï¸ _internalä¾èµ–æ–‡ä»¶å¤¹ä¸å­˜åœ¨"
          }
        } else {
          Write-Output "âŒ Windowså¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        $releaseDir = "release\PD-Signal-Windows"
        if (Test-Path $releaseDir) { Remove-Item -Recurse -Force $releaseDir }
        New-Item -ItemType Directory $releaseDir
        
        # å¤åˆ¶æ•´ä¸ªPD-Signalç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
        Copy-Item "dist\PD-Signal" "$releaseDir\" -Recurse
        
        # å¤åˆ¶ä½¿ç”¨è¯´æ˜
        Copy-Item "dist\ä½¿ç”¨è¯´æ˜.txt" "$releaseDir\" -ErrorAction SilentlyContinue
        
        # å¤åˆ¶æºç å’Œæ–‡æ¡£
        New-Item -ItemType Directory "$releaseDir\source"
        Copy-Item "*.py" "$releaseDir\source\"
        Copy-Item "requirements.txt" "$releaseDir\source\"
        Copy-Item "README_CN.md" "$releaseDir\source\"
        Copy-Item "project_overview.md" "$releaseDir\source\"
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        $versionInfo = "PD Signal - PandaLiveç›‘æ§å·¥å…·`nç‰ˆæœ¬: ${{ env.BUILD_VERSION }}`næ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`næ„å»ºç¯å¢ƒ: GitHub Actions Windows`nPythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}`nGitæäº¤: ${{ github.sha }}`n`nğŸ“ æ–‡ä»¶ç»“æ„:`n- PD-Signal.exe (ä¸»ç¨‹åº)`n- _internal/ (æ‰€æœ‰ä¾èµ–æ–‡ä»¶)`n- ä½¿ç”¨è¯´æ˜.txt (ä½¿ç”¨è¯´æ˜)`n- source/ (æºä»£ç )`n`nğŸ’¡ ä½¿ç”¨è¯´æ˜:`n1. ç›´æ¥è¿è¡Œ PD-Signal.exe å¯åŠ¨ç¨‹åº`n2. ç¨‹åºåŒ…å«æ‰€æœ‰ä¾èµ–ï¼Œæ— éœ€é¢å¤–å®‰è£…`n3. å·²ä¿®å¤é‡å¤åˆ›å»ºè¿›ç¨‹çš„é—®é¢˜`n4. æ”¯æŒå•å®ä¾‹è¿è¡Œï¼Œé¿å…å¤šå¼€"
        $versionInfo | Out-File -FilePath "$releaseDir\ç‰ˆæœ¬ä¿¡æ¯.txt" -Encoding UTF8
        
    - name: éªŒè¯å‘å¸ƒæ–‡ä»¶å­˜åœ¨
      shell: pwsh
      run: |
        Write-Output "=== éªŒè¯å‘å¸ƒæ–‡ä»¶ ==="
        $files = @(
          "dist\PD-Signal\PD-Signal.exe",
          "dist\ä½¿ç”¨è¯´æ˜.txt",
          "release\PD-Signal-Windows\ç‰ˆæœ¬ä¿¡æ¯.txt"
        )
        
        foreach ($file in $files) {
          if (Test-Path $file) {
            $size = (Get-Item $file).Length / 1KB
            Write-Output "âœ… $file å­˜åœ¨ ($([math]::Round($size, 2)) KB)"
          } else {
            Write-Output "âŒ $file ä¸å­˜åœ¨"
            exit 1
          }
        }
        
    - name: åˆ›å»ºGitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/PD-Signal/PD-Signal.exe
          dist/ä½¿ç”¨è¯´æ˜.txt
          release/PD-Signal-Windows/ç‰ˆæœ¬ä¿¡æ¯.txt
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## PD Signal v${{ github.ref_name }}
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `PD-Signal.exe` ç›´æ¥è¿è¡Œ
          - è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ `ä½¿ç”¨è¯´æ˜.txt`
          
          ### ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹
          - âœ… å¤šä¸»æ’­ç›‘æ§
          - âœ… å®æ—¶é€šçŸ¥
          - âœ… Windowsç³»ç»Ÿé€šçŸ¥
          - âœ… ç°ä»£åŒ–GUIç•Œé¢
          - âœ… æ•°æ®æŒä¹…åŒ–å­˜å‚¨
          - âœ… é…ç½®è‡ªåŠ¨ä¿å­˜
          
          ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ `ä½¿ç”¨è¯´æ˜.txt` æ–‡ä»¶ã€‚
          
          ### ğŸ”§ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          - ç‰ˆæœ¬: ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¾“å‡ºæ„å»ºä¿¡æ¯
      shell: pwsh
      run: |
        Write-Output "=========================================="
        Write-Output "ğŸ‰ Windowså‘å¸ƒæ„å»ºå®Œæˆï¼"
        Write-Output "=========================================="
        Write-Output "ğŸ“ æ„å»ºäº§ç‰©:"
        Get-ChildItem "dist" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Output "   - $($_.Name) ($([math]::Round($size, 2)) MB)"
        }
        Write-Output ""
        Write-Output "ğŸ“¦ å‘å¸ƒåŒ…:"
        Get-ChildItem "release\PD-Signal-Windows" | ForEach-Object {
          Write-Output "   - $($_.Name)"
        }
        Write-Output ""
        Write-Output "ğŸ’¡ ä½¿ç”¨è¯´æ˜:"
        Write-Output "   1. ä¸‹è½½ PD-Signal.exe è¿è¡Œç¨‹åº"
        Write-Output "   2. é˜…è¯» ä½¿ç”¨è¯´æ˜.txt äº†è§£è¯¦ç»†ç”¨æ³•"
        Write-Output "=========================================="
